---
title: "taxonomy"
author: "pgfarsund"
date: "`r Sys.Date()`"
output: html_document
---

# we will summarise the relative abundance of (relatively) high taxonomic levels 
# for each group and across the successional stages. the three top taxa should
# be mentioned in the text and will be accompanied by krona charts. metacoder
# trees will also be included, but they should emphasise differentially 
# abundant taxa rather than taxonomic composition. 

# load library
```{r}
library(here)
library(phyloseq)
library(tidyverse)
library(psadd)
#
```


# bacteria
```{r}

bacteria <- readRDS(here("data/bacteria/heathland-fire-bacteria.RDS")); bacteria
sample_sums(bacteria)

# normalize the number of reads per sample: 
bacrar <- rarefy_even_depth(bacteria, 
                            rngseed = 123,
                            replace = F, 
                            trimOTUs = T, 
                            sample.size = 18963); bacteria; bacrar

# use this object to calculate relative abundance at the phylum level: 
bacglom <- tax_glom(bacrar, taxrank = "Phylum", NArm = T); bacrar; bacglom

bactop <- names(sort(taxa_sums(bacglom), decreasing = TRUE))[1:10]; bactop # get top10 names
bactop <- prune_taxa(bactop, bacglom); bactop; sum(taxa_sums(bactop))

bacbottom <- names(sort(taxa_sums(bacglom), decreasing = FALSE))[1:c(ntaxa(bacglom)-ntaxa(bactop))]

bacbottom <- prune_taxa(bacbottom, bacglom); bacbottom; sum(taxa_sums(bacbottom))

bacbottom@tax_table[,"Kingdom"] = "Other"

bacbottom@tax_table[,"Phylum"] = "Other"

bacbottom; bacbottom <- tax_glom(bacbottom, taxrank = "Phylum", NArm = TRUE); bacbottom
#

bactop <- merge_phyloseq(bactop, bacbottom)
#bactop <- merge_samples(bactop, group = "phase", fun = mean); bactop
#bactop <- transform_sample_counts(bactop, function(x) x / sum(x)); bactop; rowSums(bactop@otu_table)
df <- psmelt(bactop) %>% 
  rename("taxlevel" = "Phylum")

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
bacfillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

bacfillvector <- aggregate(bacfillvector$df.Abundance, by=list(bacfillvector$df.taxlevel), FUN = sum)

colnames(bacfillvector) <- c("df.taxlevel", "df.Abundance")

bacfillvector <- bacfillvector[order(bacfillvector$df.Abundance, decreasing = TRUE),]

bacfillvector = unique(bacfillvector$df.taxlevel)
#############################
# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Phylum" = "taxlevel") -> bactax

bactax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Phylum, levels = c(bacfillvector, "Other")),
             color=factor(Phylum, levels = c(bacfillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Bacteria") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Phylum", nrow = 4), 
         color = guide_legend(title="Phylum", nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip() -> bactaxplot; bactaxplot 

```


# fungi
```{r}

fungi <- readRDS(here("data/fungi/heathland-fire-fungi.RDS")); fungi
fungi <- prune_taxa(taxa_sums(fungi)>0, fungi); fungi

# normalize the number of reads per sample: 
funrar <- rarefy_even_depth(fungi, 
                            rngseed = 123,
                            replace = F, 
                            trimOTUs = T, 
                            sample.size = min(sample_sums(fungi))); fungi; funrar

# use this object to calculate relative abundance at the phylum level: 
glom <- tax_glom(funrar, taxrank = "Class", NArm = T); funrar; glom

top <- names(sort(taxa_sums(glom), decreasing = TRUE))[1:10]; top # get top10 names
top <- prune_taxa(top, glom); top; sum(taxa_sums(top))

bottom <- names(sort(taxa_sums(glom), decreasing = F))[1:c(ntaxa(glom)-ntaxa(top))]

bottom <- prune_taxa(bottom, glom); bottom; sum(taxa_sums(bottom))

bottom@tax_table[,"Kingdom"] = "Other"
bottom@tax_table[,"Phylum"] = "Other"
bottom@tax_table[,"Class"] = "Other"

bottom; bottom = tax_glom(bottom, taxrank = "Class", NArm = TRUE); bottom # 
#

top <- merge_phyloseq(top, bottom)
sample_data(top) <- sample_data(funrar)
df <- psmelt(top) %>% 
  rename("taxlevel" = "Class") %>% 
  mutate(taxlevel = sub("c__", "", taxlevel)) 

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
funfillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

funfillvector <- aggregate(funfillvector$df.Abundance, by=list(funfillvector$df.taxlevel), FUN = sum)

colnames(funfillvector) <- c("df.taxlevel", "df.Abundance")

funfillvector <- funfillvector[order(funfillvector$df.Abundance, decreasing = TRUE),]

funfillvector = unique(funfillvector$df.taxlevel)

# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax; ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax; btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax; mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Class" = "taxlevel") -> funtax
#

funtax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Class, levels = c(funfillvector, "Other")),
             color=factor(Class, levels = c(funfillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Fungi") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Class", nrow = 4), 
         color = guide_legend(title="Class", nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip() -> funtaxplot; funtaxplot 

```


# nematodes
```{r}

nematodes <- readRDS(here("data/nematodes/heathland-fire-nematodes.RDS")); nematodes
nematodes <- prune_taxa(taxa_sums(nematodes) > 0, nematodes); nematodes

nemrar <- rarefy_even_depth(nematodes, 
                            rngseed = 123,
                            replace = F, 
                            trimOTUs = T, 
                            sample.size = min(sample_sums(nematodes))); nematodes; nemrar

# use this object to calculate relative abundance at the phylum level: 
glom <- tax_glom(nemrar, taxrank = "genus", NArm = T); nemrar; glom

top <- names(sort(taxa_sums(glom), decreasing = TRUE))[1:10]; top # get top10 names
top <- prune_taxa(top, glom); top; sum(taxa_sums(top))

bottom <- names(sort(taxa_sums(glom), decreasing = F))[1:c(ntaxa(glom)-ntaxa(top))]

bottom <- prune_taxa(bottom, glom); bottom; sum(taxa_sums(bottom))

bottom@tax_table[,"kingdom"] = "Other"
bottom@tax_table[,"phylum"] = "Other"
bottom@tax_table[,"class"] = "Other"
bottom@tax_table[,"order"] = "Other"
bottom@tax_table[,"family"] = "Other"
bottom@tax_table[,"genus"] = "Other"

bottom; bottom = tax_glom(bottom, taxrank = "genus", NArm = TRUE); bottom # 
#

top <- merge_phyloseq(top, bottom)
sample_data(top) <- sample_data(nemrar)
df <- psmelt(top) %>% 
  rename("taxlevel" = "genus") 

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
nemfillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

nemfillvector <- aggregate(nemfillvector$df.Abundance, by=list(nemfillvector$df.taxlevel), FUN = sum)

colnames(nemfillvector) <- c("df.taxlevel", "df.Abundance")

nemfillvector <- nemfillvector[order(nemfillvector$df.Abundance, decreasing = TRUE),]

nemfillvector = unique(nemfillvector$df.taxlevel)

# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax; ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax; btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax; mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Genus" = "taxlevel") -> nemtax
#

nemtax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Genus, levels = c(nemfillvector, "Other")),
             color=factor(Genus, levels = c(nemfillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Nematodes") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Genus", nrow = 4), 
         color = guide_legend(title="Genus", nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip() -> nemtaxplot; nemtaxplot 

```


# pitfall traps
```{r}

walk <- readRDS(here("data/walking_arthropods/heathland-fire-walking-arthropods.RDS")); walk
walk <- prune_taxa(taxa_sums(walk) > 0, walk); walk

warar <- rarefy_even_depth(walk, 
                           rngseed = 123,
                           replace = F, 
                           trimOTUs = T, 
                           sample.size = 10); walk; warar
warar@tax_table <- tax_table(as.matrix(data.frame("order" = colnames(warar@otu_table), 
                                                  row.names = colnames(warar@otu_table)))); warar

# use this object to calculate relative abundance at the phylum level: 
glom <- tax_glom(warar, taxrank = "order", NArm = T); warar; glom

top <- names(sort(taxa_sums(glom), decreasing = TRUE))[1:10]; top # get top10 names
top <- prune_taxa(top, glom); top; sum(taxa_sums(top))

bottom <- names(sort(taxa_sums(glom), decreasing = F))[1:c(ntaxa(glom)-ntaxa(top))]

bottom <- prune_taxa(bottom, glom); bottom; sum(taxa_sums(bottom))

bottom@tax_table[,"order"] = "Other"

bottom; bottom = tax_glom(bottom, taxrank = "order", NArm = TRUE); bottom # 
#

top <- merge_phyloseq(top, bottom)
sample_data(top) <- sample_data(warar)
df <- psmelt(top) %>% 
  rename("taxlevel" = "order") 

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
wafillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

wafillvector <- aggregate(wafillvector$df.Abundance, by=list(wafillvector$df.taxlevel), FUN = sum)

colnames(wafillvector) <- c("df.taxlevel", "df.Abundance")

wafillvector <- wafillvector[order(wafillvector$df.Abundance, decreasing = TRUE),]

wafillvector = unique(wafillvector$df.taxlevel)

# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax; ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax; btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax; mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Genus" = "taxlevel") -> watax
#

watax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Genus, levels = c(wafillvector, "Other")),
             color=factor(Genus, levels = c(wafillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Walking arthropods") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Group", 
                             nrow = 4), 
         color = guide_legend(title="Group", 
                              nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip() -> wataxplot; wataxplot 
#
```


# flying insects
```{r}

insects <- readRDS(here("data/insects/heathland-fire-insects.RDS")); insects
insects <- prune_taxa(taxa_sums(insects) >0, insects); insects

inrar <- rarefy_even_depth(insects, 
                           rngseed = 123,
                           replace = F, 
                           trimOTUs = T, 
                           sample.size = min(sample_sums(insects))); insects; inrar

# use this object to calculate relative abundance at the phylum level: 
glom <- tax_glom(inrar, taxrank = "order", NArm = T); inrar; glom

top <- names(sort(taxa_sums(glom), decreasing = TRUE))[1:11]; top # get top10 names
top <- prune_taxa(top, glom); top; sum(taxa_sums(top))

bottom <- names(sort(taxa_sums(glom), decreasing = F))[1:c(ntaxa(glom)-ntaxa(top))]

bottom <- prune_taxa(bottom, glom); bottom; sum(taxa_sums(bottom))

bottom@tax_table[,"order"] = "Other"

bottom; bottom <- tax_glom(bottom, taxrank = "order", NArm = TRUE); bottom # 
#

top <- merge_phyloseq(top, bottom)
sample_data(top) <- sample_data(inrar)
df <- psmelt(top) %>% 
  rename("taxlevel" = "order") 

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
infillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

infillvector <- aggregate(infillvector$df.Abundance, by=list(infillvector$df.taxlevel), FUN = sum)

colnames(infillvector) <- c("df.taxlevel", "df.Abundance")

infillvector <- infillvector[order(infillvector$df.Abundance, decreasing = TRUE),]

infillvector = unique(infillvector$df.taxlevel)

# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax; ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax; btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax; mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Genus" = "taxlevel") -> intax
#

intax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Genus, levels = c(infillvector, "Other")),
             color=factor(Genus, levels = c(infillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Flying insects******") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Group", nrow = 4), 
         color = guide_legend(title="Group", nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip(ylim = c(0, 0.45)) -> intaxplot; intaxplot 
#

# make krona charts to go along with the results:
#nemrar@sam_data$phase <- sub("Pioner", "P", nemrar@sam_data$phase)
#nemrar@sam_data$phase <- sub("Bygg", "B", nemrar@sam_data$phase)
#nemrar@sam_data$phase <- sub("Moden", "M", nemrar@sam_data$phase)
#nemrar@tax_table[,""]

#plot_krona(nemrar, output = c("~/Desktop/"), variable = "phase")
#
```


# plants
```{r}

plants <- readRDS("data/plants/heathland-fire-plants.RDS")
plants <- prune_taxa(taxa_sums(plants) > 0, plants); plants

plants@tax_table <- tax_table(as.matrix(data.frame("group" = colnames(plants@otu_table), 
                                                   row.names = colnames(plants@otu_table)))); plants

# use this object to calculate relative abundance at the phylum level: 
glom <- tax_glom(plants, taxrank = "group", NArm = T); plants; glom

top <- names(sort(taxa_sums(glom), decreasing = TRUE))[1:10]; top # get top10 names
top <- prune_taxa(top, glom); top; sum(taxa_sums(top)) # make a phyloseq object with the top 10 taxa

bottom <- names(sort(taxa_sums(glom), decreasing = F))[1:c(ntaxa(glom)-ntaxa(top))]

bottom <- prune_taxa(bottom, glom); bottom; sum(taxa_sums(bottom)) # make a ps object form bottom taxa

bottom@tax_table[,"group"] = "Other"

#bottom <- tax_glom(bottom, taxrank = "group", NArm = TRUE); bottom # 
#

top <- merge_phyloseq(top, bottom)
sample_data(top) <- sample_data(plants)
df <- psmelt(top) %>% 
  rename("taxlevel" = "group") 

# We need a custom color palette with 11 colors:
library(RColorBrewer)
custcol <- c(brewer.pal(name = "Paired", n = 10), "grey")

# make stuff for fill:
plafillvector <- data.frame(df$taxlevel, df$Abundance) %>% 
  filter(df.taxlevel!="Other")

plafillvector <- aggregate(plafillvector$df.Abundance, by=list(plafillvector$df.taxlevel), FUN = sum)

colnames(plafillvector) <- c("df.taxlevel", "df.Abundance")

plafillvector <- plafillvector[order(plafillvector$df.Abundance, decreasing = TRUE),]

plafillvector = unique(plafillvector$df.taxlevel)

# P-phase: 
df %>% 
  mutate(phase = sub("Pioner", "P", phase)) %>% 
  filter(phase == "P") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(p_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         p_relab) %>% 
  distinct() %>% 
  arrange(-p_relab) -> ptax; ptax

# B-phase
df %>% 
  mutate(phase = sub("Bygg", "B", phase)) %>% 
  filter(phase == "B") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(b_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         b_relab) %>% 
  distinct() %>% 
  arrange(-b_relab) -> btax; btax

# M-phase
df %>% 
  mutate(phase = sub("Moden", "M", phase)) %>% 
  filter(phase == "M") %>% 
  select(phase, 
         taxlevel, 
         Abundance) %>% 
  mutate(relab = Abundance / sum(Abundance)) %>% 
  mutate(m_relab = sum(relab), .by = taxlevel) %>% 
  select(taxlevel, 
         m_relab) %>% 
  distinct() %>% 
  arrange(-m_relab) -> mtax; mtax

ptax %>% 
  left_join(btax, by = c("taxlevel")) %>% 
  left_join(mtax, by = "taxlevel") %>% 
  rename("Genus" = "taxlevel") -> platax
#

platax %>% 
  pivot_longer(cols = c(p_relab, 
                        b_relab, 
                        m_relab), 
               names_to = "phase", 
               values_to = "relab") %>% 
  mutate(phase = recode(phase, 
                        "p_relab" = "P", 
                        "b_relab" = "B", 
                        "m_relab" = "M")) %>% 
  ggplot(aes(x=factor(phase, levels = rev(c("P", "B", "M"))), 
             y=relab, 
             fill=factor(Genus, levels = c(plafillvector, "Other")),
             color=factor(Genus, levels = c(plafillvector, "Other")))) + 
  theme_grey(base_size = 18) +
  geom_col(width = 0.75) + 
  scale_fill_manual(values=custcol) +
  scale_color_manual(values = rep("black", times=length(unique(df$taxlevel)))) + 
  ylab("Relative abundance (%)") + 
  labs(title = "Plants") +
  scale_y_continuous(labels = scales::percent_format()) + 
  guides(fill = guide_legend(title="Group", nrow = 4), 
         color = guide_legend(title="Group", nrow = 4)) +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text()) +
  coord_flip() -> plataxplot; plataxplot 
#

# make krona charts to go along with the results:
#nemrar@sam_data$phase <- sub("Pioner", "P", nemrar@sam_data$phase)
#nemrar@sam_data$phase <- sub("Bygg", "B", nemrar@sam_data$phase)
#nemrar@sam_data$phase <- sub("Moden", "M", nemrar@sam_data$phase)
#nemrar@tax_table[,""]

#plot_krona(nemrar, output = c("~/Desktop/"), variable = "phase")
#
```


# arrange the plots
```{r}
library(ggpubr)

ggarrange(
  bactaxplot, 
  funtaxplot, 
  nemtaxplot, 
  wataxplot, 
  intaxplot, 
  plataxplot, 
  nrow = 2,
  ncol = 3,
  widths = c(1, 1, 1,  
             1, 1, 1), 
  heights = c(1, 1, 1, 
              1, 1, 1)
)
#
```


